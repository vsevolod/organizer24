to_i = (date_or_number) ->
  if typeof( date_or_number ) == 'number'
    date_or_number
  else
    date_or_number.valueOf() / 1000

$('#calendar').fullCalendar({
  header: {
    left: 'prev,next today',
    center: 'title',
    right: ''
  },
  firstDay: 1,
  aspectRatio: 1.5,
  defaultView: 'agendaWeek',
  allDaySlot: false,
  allDayDefault: false,
  minTime: start_calendar_options.minTime*1.0/(60*60),
  maxTime: start_calendar_options.maxTime*1.0/(60*60),
  slotMinutes: start_calendar_options.slotMinutes,
  monthNames: <%= I18n.t('date.standalone_month_names').compact %>,
  dayNames: <%= I18n.t('date.standalone_day_names').compact %>,

  axisFormat: 'HH:mm',
  timeFormat: {
    agenda: 'H:mm{ - H:mm}',
    '': 'H(:mm)'
  },
  columnFormat: {
    week: "dd.MM.yyyy '<br/>' dddd",
  },
  titleFormat: {
    week: "MMMM d[ yyyy]{ '&#8212;'[ MMMM] d yyyy"
  },
  buttonText: {
    today: 'Сегодня'
  },
  eventSources: [
    {
      url: '/organizations/'+start_calendar_options.organization_id+'/working_hours/by_week',
      backgroundColor: '#ccc',
      borderColor: '#ccc'
    }
  ],
  selectable: true,
  selectHelper: true,
  editable: false,
  droppable: true,
  drop: ((date, allDay) ->
    originalEventObject = $(this).data('eventObject')
    copiedEventObject = $.extend({
      editable: true,
      disableDragging: true,
      disableResizing: true,
      _id: 100000
    }, originalEventObject)
    copiedEventObject.start = date
    copiedEventObject.end = date.valueOf()/1000 + originalEventObject.duration*60
    copiedEventObject.allDay = allDay
    intersection = $.grep( $('#calendar').fullCalendar('clientEvents'), (el) ->
      if Array.max( [to_i( el.start ), to_i( copiedEventObject.start )] ) < Array.min( [to_i( el.end ), to_i( copiedEventObject.end )] )
        return el
    )
    end_date = new Date( copiedEventObject.end*1000)
    if intersection.length > 0
      alert('Запись на этот период невозможна')
    else
      if (end_date.getHours()*60+end_date.getMinutes())*60 <= start_calendar_options.maxTime
        $('#calendar').fullCalendar('renderEvent', copiedEventObject, true)
        $(this).hide()
        $('.check_services input').attr('disabled', true)
        $('.buttons_to_confirm').show()
      else
        alert('Рабочий день заканчивается')
  ),
  eventAfterRender: (event, element, view) ->
    #console.log( event )
    #console.log( element )
    #console.log( view )
})

$('.confirm_calendar').click ->
  alert('asd')

$('.cancel_calendar').click ->
  $(this).parent().hide()
  $(this).parent().next().show()
  $('.check_services input').attr('disabled', false)
  $('#calendar').fullCalendar( 'removeEvents', 100000 )
